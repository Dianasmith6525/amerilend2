# AmeriLend Deployment Environment Variables Guide

This guide explains all environment variables needed for deployment on Vercel + Railway.

---

## ðŸ“‹ Environment Variables by Service

### Frontend (Vercel) - React/Vite

**Required Variables:**

```env
# API URL - Points to your Railway backend
VITE_API_URL=https://api.amerilendloan.com

# App ID for OAuth
VITE_APP_ID=your_app_id_here

# Optional: Analytics
VITE_GOOGLE_ANALYTICS_ID=
VITE_AMPLITUDE_API_KEY=
```

**Where to set them:**
1. Go to Vercel Dashboard â†’ Project â†’ Settings â†’ Environment Variables
2. Add each variable above
3. Make sure they're available in all environments (Production, Preview, Development)

---

### Backend (Railway) - Express + tRPC

**Database:**

```env
# PostgreSQL connection string
# Format: postgresql://user:password@host:port/database
# Railway provides this automatically as DATABASE_URL
DATABASE_URL=postgresql://user:password@localhost:5432/amerilend_db
```

**Authentication & Sessions:**

```env
# JWT Secret for signing session tokens
# Generate: openssl rand -base64 32
JWT_SECRET=your_super_secret_jwt_key_min_32_chars

# Node Environment
NODE_ENV=production
```

**OAuth Configuration:**

```env
# OAuth Server URL (for Google OAuth, Microsoft, etc.)
OAUTH_SERVER_URL=https://your-oauth-provider.com

# Your App ID registered with OAuth provider
VITE_APP_ID=your_app_id_from_oauth_provider
```

**Email Service (SendGrid):**

```env
# SendGrid API Key
# Get from: https://app.sendgrid.com/settings/api_keys
SENDGRID_API_KEY=SG.your_api_key_here

# From email address (must be verified in SendGrid)
SENDGRID_FROM_EMAIL=noreply@amerilendloan.com

# Reply-to email (optional)
SENDGRID_REPLY_EMAIL=support@amerilendloan.com
```

**Payment Processing:**

```env
# Authorize.Net (if using Authorize.Net)
AUTHORIZE_NET_API_KEY=your_api_login_id
AUTHORIZE_NET_TRANSACTION_KEY=your_transaction_key
AUTHORIZE_NET_ENVIRONMENT=production

# Stripe (if using Stripe)
STRIPE_SECRET_KEY=sk_live_your_secret_key
STRIPE_PUBLISHABLE_KEY=pk_live_your_publishable_key
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret
```

**Application URLs:**

```env
# Frontend URL (for redirects and CORS)
VITE_CLIENT_URL=https://amerilendloan.com

# API URL (for client to reach backend)
VITE_API_URL=https://api.amerilendloan.com

# Backend server port (Railway sets this automatically)
PORT=3000
```

**Logging & Monitoring:**

```env
# Log Level (debug, info, warn, error)
LOG_LEVEL=info

# Optional: Sentry for error tracking
SENTRY_DSN=https://your_sentry_dsn@sentry.io/project_id
```

---

## ðŸ” How to Get Each Secret

### JWT_SECRET
```bash
# Generate a secure random secret
openssl rand -base64 32

# Or use this online tool:
# https://www.uuidgenerator.net/
```

### SENDGRID_API_KEY
1. Go to https://app.sendgrid.com
2. Navigate to **Settings** â†’ **API Keys**
3. Create a new API key (Full Access or restricted)
4. Copy the key and paste into Vercel/Railway

### OAUTH_SERVER_URL & VITE_APP_ID
- Contact your OAuth provider (Google, Microsoft, Apple, Facebook)
- Register your application
- Get the OAuth server URL and App ID
- May need to add redirect URIs: `https://amerilendloan.com/api/auth/callback`

### AUTHORIZE_NET_API_KEY & AUTHORIZE_NET_TRANSACTION_KEY
1. Log in to Authorize.Net merchant account
2. Go to **Settings** â†’ **Security Settings**
3. Generate new API credentials
4. Copy API Login ID and Transaction Key

### STRIPE_SECRET_KEY & STRIPE_PUBLISHABLE_KEY
1. Go to https://dashboard.stripe.com
2. Navigate to **Developers** â†’ **API Keys**
3. Copy the Live Secret Key and Publishable Key
4. Create webhook at **Developers** â†’ **Webhooks**
5. Add endpoint: `https://api.amerilendloan.com/api/stripe-webhook`

### DATABASE_URL
- Railway automatically provides this when PostgreSQL is created
- Format: `postgresql://user:password@host:port/db`
- You can see it in Railway Dashboard â†’ PostgreSQL â†’ Connect

---

## ðŸš€ Deployment Steps

### Step 1: Set Up Vercel Environment Variables

```
VITE_API_URL = https://api.amerilendloan.com
VITE_APP_ID = your_app_id
```

### Step 2: Set Up Railway Environment Variables

```
# Core
NODE_ENV = production
DATABASE_URL = (auto-generated by Railway)

# Secrets (use Railway Secrets feature)
JWT_SECRET = your_jwt_secret
OAUTH_SERVER_URL = your_oauth_url
VITE_APP_ID = your_app_id
SENDGRID_API_KEY = your_sendgrid_key
AUTHORIZE_NET_API_KEY = your_auth_net_key
AUTHORIZE_NET_TRANSACTION_KEY = your_transaction_key
STRIPE_SECRET_KEY = your_stripe_key
```

### Step 3: Configure CORS

In your backend, update CORS to allow Vercel frontend:

```typescript
// server/_core/index.ts
const cors = {
  origin: [
    "https://amerilendloan.com",
    "https://www.amerilendloan.com",
    "http://localhost:5173" // for local development
  ],
  credentials: true
};
```

### Step 4: Update Domain DNS

Once deployed, point your Wix domain to:
- **Frontend (Vercel)**: `amerilendloan.com` â†’ Vercel nameservers
- **Backend (Railway)**: `api.amerilendloan.com` â†’ Railway CNAME

---

## âœ… Verification Checklist

After deployment, verify:

- [ ] Frontend loads at `https://amerilendloan.com`
- [ ] Backend responds at `https://api.amerilendloan.com/api/trpc`
- [ ] Emails send from `noreply@amerilendloan.com`
- [ ] OAuth login works
- [ ] Payment processing works
- [ ] SSL certificate shows valid (green padlock)
- [ ] No console errors in browser DevTools
- [ ] API response includes proper CORS headers

---

## ðŸ”§ Local Development

To test locally before deploying:

```bash
# Install dependencies
pnpm install

# Create .env.local for local development
cat > .env.local << EOF
VITE_API_URL=http://localhost:3000
VITE_APP_ID=local_app_id
DATABASE_URL=postgresql://user:password@localhost:5432/amerilend_local
JWT_SECRET=local_jwt_secret_for_testing
SENDGRID_API_KEY=your_key
NODE_ENV=development
EOF

# Start development server
pnpm dev

# Backend runs on: http://localhost:3000
# Frontend runs on: http://localhost:5173
```

---

## ðŸ†˜ Troubleshooting

### Emails not sending
- [ ] Verify SENDGRID_API_KEY in Railway
- [ ] Verify from email is authenticated in SendGrid
- [ ] Check SendGrid Activity â†’ Bounces for delivery issues

### API returning 401 Unauthorized
- [ ] Check JWT_SECRET matches between Vercel and Railway
- [ ] Verify SESSION_COOKIE_NAME env var
- [ ] Check browser cookies in DevTools

### CORS errors
- [ ] Add frontend URL to CORS origin array in backend
- [ ] Verify credentials: true is set
- [ ] Check Access-Control-Allow-* headers in response

### Database connection failed
- [ ] Verify DATABASE_URL format: `postgresql://user:pass@host:port/db`
- [ ] Ensure Railway PostgreSQL is running
- [ ] Run migrations: `pnpm run db:push`

### OAuth redirect loop
- [ ] Verify redirect URI in OAuth provider settings
- [ ] Ensure OAUTH_SERVER_URL is correct
- [ ] Check VITE_APP_ID matches provider registration

---

## ðŸ“š Additional Resources

- **Vercel Docs**: https://vercel.com/docs/concepts/environment-variables
- **Railway Docs**: https://railway.app/docs/guides/environments
- **SendGrid API**: https://sendgrid.com/docs/api-reference/
- **Authorize.Net**: https://developer.authorize.net/
- **Stripe**: https://stripe.com/docs
- **PostgreSQL**: https://www.postgresql.org/docs/

---

## ðŸ” Security Best Practices

1. **Never commit secrets** - Use Railway Secrets or Vercel Secrets
2. **Rotate keys regularly** - Change JWT_SECRET and API keys quarterly
3. **Use HTTPS everywhere** - All URLs should be https://
4. **Restrict CORS** - Only allow your frontend domain
5. **Monitor logs** - Check Railway and Vercel logs for errors
6. **Set up alerts** - Get notifications for deployment failures

---

